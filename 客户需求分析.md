





在出站时，如果收到 MES的回复 2 ，表示MES判定物料无料了

那么，出站还是回复 PLC 100，

于此同时，事件发布，给PLC  新建的停机报警标签发  信号  2，PLC进行停机报警



注意，因为双工位出站，所以，PLC可能会连续两次收到 上位机写来的 信号2 ，

那么PLC在收到 信号之后  建议是延迟1秒左右，收到2或者1，都要停机报警

且 PLC特殊处理 这个2 



PLC收到2之后，停机报警，

并且，弹框 出来，显示：“MES出站判定没有了辅料，请重新上料之后，再点击这里的确认”



这个时候，操作员 在上位机重新上料之后，那么点击这里的  确认之后，才可以点击 复位 ，机台重新启动

这里的确认点击之后，还是这个W标签，写入100，上位机会监控这个值

一旦上位机监控得到这个值100，那么上位机后台从数据库中 打捞一遍无料的数据，重新上传，

且机台重启之后，无料还是会正常往下一个工序流



特别注意，如果操作员没有重新投料，就点击了确认，PLC还是发100

上位机监控这个100，还是会调用出站接口，在再次收到MES回复的2之后，上位机还是会再发在W标签发2给PLC

PLC还是停机报警，又弹框

（无料的异常不解决，操作员无法正常生产，强制性要求投料）







当前上位机将MES状态同步到PLC的逻辑是：

上位机发 bool 类型的数据到PLC

false:设备与MES断开（停机报警）

true：设备与MES正常连接



优化一下：

bool类型改成 short 类型数据

1，（设备与MES正常连接）

2，MES未连接，请在上位机点击登录 MES系统（停机报警）

3，MES未连接，请在上位机切换MES在线模式（停机报警）

4，MES异常断开，请检查MES连接状态（停机报警）





汇川地址：

|var|Inovance-PLC.Application.PC.MesDetection

倍福地址：

PC.MesDetection



15号之前 应该可以

在一个固定的时间点上传操作日志到FTP服务器

2，总逻辑是，定时job，将本地文件夹下的日志上传到FTP服务器，上传成功之后，删除本地文件下的该文件，如果没有上传成功，那么不删，job下一次执行时 自动补传，成功之后还是删除（上传操作是对文件夹下的所有文件上传一次）

3，手动补传，在操作日志的导出按钮旁边  制作一个 补传按钮，逻辑是，进入文件下，选择文件（与选择交互表导入类似，参考选择字典表导入的控制器操作），这里 按钮按下之后，将此文件上传FTP服务器，成功之后删除 此文件（注意人工选择可能会有误操作，所以必须校验一次文件路径）

5，操作日志定时导出（先定时导出到本地，然后定时上传，这两个定时任务是一个job），保存在本地文件下，当天的固定时间，导出前一整天的数据文件（csv）到本地文件夹，对于当天导出时间点截止的数据，也导出当天的文件（从当天的0点到导出时刻），此文件也上传FTP，

对于从昨天导出时间点start 到 今天导出时间点end  这段时间的数据，拆开到两天两个文件的数据

也就是说，今天导出的时候，一方面导出前一整天的数据文件，上传FTP，如果FTP存在则**覆盖**，另一方面，将今天0点到当前导出时间点的数据导出上传









产品数据直接用当前的复制，然后直接上传到指定路径，如果有就覆盖跟新

操作日志就导出然后上传，（导出  **昨天一整天的以及 今天截止到当前时间的**  到本地路径，上传成功则删除，如果服务器有那么覆盖）

操作日志与产品数据  每一次上传两天的文件，跟新昨天一整天的以及 今天截止到当前时间的



- [x] 固定时间点 精确的设置job在一个确切的时间点执行
- [x] FTP的代码做成 服务层代码
- [x] FTP的一系列设置 放在字典表，包括各个机台的上传时间点
- [ ] 转接片出站时上传顶盖进站时间





称重NG，会在出站口排出来

如果一个称重OK，一个称重NG，想要NG数据上传，而此时的称重OK的数据不上传，

此时的两个电芯没有焊接，且A,B电芯无法确认，

还是需要人工确认到底是A电芯称重NG，还是B电芯称重NG

预焊机没有缓存位，还是需要人工挑一个A一个B 去复投

称重NG的料，复投还是会称重NG





此电芯与另一面的电芯称重NG一起排出（注意此电芯没有调用出站接口，不用解除NC，可直接复投）



从设备功能实现上考虑，很难改



称重NG，两个电芯没有焊接，且A,B电芯无法区分确认，
设备无法确认到底是A电芯称重NG，还是B电芯称重NG
预焊机没有缓存位，还是需要人工确认 挑一个A一个B 去复投



