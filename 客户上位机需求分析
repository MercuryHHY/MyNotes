1，上位机自动卸料不用再做，mes出站接口调用的时候，也不用再上传 "BindFeedingCodes" 这种物料码

2， 上位机条码上料，调用上料接口，MES根据设备上传的物料条码进行验证是否可用，

如果出现异常，上位机根据MES返回的信息（msg）出一个弹框提醒，提醒内容为msg内容，操作人员会根据msg内容更换条码或者修改数量进行重新上料；

3， MES提供物料查询接口，上位机新增一个**按钮**（图中的物料查询更新，名字和布局位置随意），这个按钮调用物料查询接口，更新当前设备已上物料列表，以及剩余数量；从mes获取到数据之后，在图中的**物料列表**同步显示（删除字典表中的已提交物料的本地记录，并插入从mes获取的数据）

如图

<img src="../../项目文档/BS/龙净整线/问题点收集/新增需求/1.png" style="zoom:60%;" />





4，

客户方案：

上位机出站调用MES接口，如果无法正常出站（mes返回异常，MES出站NG），上位机需要弹窗将当前出站失败原因进行显示（弹窗内容是MES的msg），异常处理完成后再进行出站（再次调用MES出站接口）



针对客户方案的个人思考：

**这里我始终觉得不对劲，所以3-7号的会议 我没有直接回复客户说可以，只是说要和上面大哥确认一下这逻辑是否正确**

这里，客户想要上位机在第一次调用mes出站接口时，如果MES回复-1表示MES出站NG，那么上位机需要弹窗将当前出站失败原因进行显示（弹窗内容是MES的msg），并且机台停机报警（机台所有动作全部停下）

异常处理完成后再进行出站（这里客户说要提供一个按钮，点击这个按钮之后  再次调用MES出站接口，并且告诉PLC可以继续刚刚那个没有出站的电芯可以出站了，并且机台恢复正常运行）

**但是这里如果有多个条码出站呢，并发的时候上位机会不会有风险**

1，PLC的程序报警之后，在恢复正常， 是否还可以继续回到处理出站那里的逻辑？,

2，我们的机台设备， 如果PLC是控制的双工位出站的呢（入壳机一次性出两个，有两次触发），会不会有冲突？

比如说一个是MES判定OK的，另一个是MES出站NG的（要处理异常之后才能继续），那这个出站逻辑PLC是否可行？

3，如果同时两个 都是MES出站NG的，那上位机如何弹框，弹两个框吗？

4，这个按钮的逻辑，我个人理解用MediatR（领域事件）处理会不会方便些

5，如果这个操作员错误操作，此时点击按钮处理之后，此时调用MES出站接口又是NG，此时如何处理





个人解决方案：

其实上面的一切，客户只是为了处理 MES出站NG的情况，只是需要重新调用MES出站接口，



第一种方案：

那在离线上传按钮的旁边  做一个**MES出站的按钮**（与离线上传极其类似，只是这个按钮只调用MES出站接口），是不是可以解决问题 

这样，设备机台不用停机报警 全部停下，有料就继续做，只是如果生产了MES出站的NG料，操作员要在上位机这里手动选择要调用的条码，上位机在NG原因那里，可以显示出msg的信息



第二种折中方案：

在出站调用mes出站接口的时候，领域事件发布处理，在出站job中领域事件发布，如果连续3次mes出站NG，那么给PLC信号，让PLC控制停机报警，事件处理方法中  弹框，停机处理完成之后，弄一个按钮，点击之后发信号告诉PLC 可以运行了，数据还是第一种的MES出站的按钮 点击补录





建议是，不能说mes直接控制机台的运行，不能说mes一旦出现问题，机台就大量的停机（如果采用客户方案），这个后果会很严重，后面又是两边扯皮，（机台说mes造成的停机，mes说生产人员没有及时处理异常，这个异常情况mes那边可能会有非常多的原因）







**条码绑定逻辑更改**



1，考虑转接片的情况，如果条码绑定失败，那么MES出站接口不会调用，并且回复35给PLC，PLC那边就会当成  MES出站NG 处理

如果条码绑定成功，那么此时继续 调用 MES出站接口，成功则成，如果返回失败，那么回复35给PLC，PLC那边也还是当成  MES出站NG 处理

（特别注意： 目前所有PLC对于 上位机出站时给它回复的35，PLC都认为是 MES出站NG，并且不会停机报警，这里是否需要PLC修改？

对于NGCode，是PLC写入在718 位置的结果，在PLC出站触发时，就已经将718的结果数据（物料状态）写入到了出站数据区，当PLC在出站触发标签得到了上位机回复的35之后，此时再将MES出站NG对应的NGcode再次写入出站数据区中的718位置，已经没有用了，上位机不会再次读这个出站数据区了）



2，超声波终焊     在MES进站接口调用的 同时，顺带调用  MES预绑定接口，如果同时成功，那么进站成功，反之，进站失败，给PLC回复35，进站NG排料，（是否需要加弹框）

在调用MES出站接口之前，调用 MES条码绑定接口，（**与转接片一样的逻辑**）

如果条码绑定接口 返回失败，那么直接给PLC返回35，不再调用MES出站接口，





3，mes就不能自己进行条码绑定吗

首先，在转接片进站的时候，MES会有条码绑定的校验，所以在终焊出站的时候，MES是不是可以自己进行条码绑定

你让我NG下料，大批量的人工处理



这个条码绑定，和上料不一样，异常的判定完全是由MES决定的，

因为条码绑定失败，依靠人工，让人工去手动处理，我还是觉得不太现实，

此外机台的运行速度 也会受到影响

如果一定要考虑人为的因素 造成的条码绑定失败，那我们认为，这个条码绑定由MES这边处理会更好

前前后后就会有4个接口需要绑定

由机台控制条码绑定，如果要考虑人为因素，那么达不到完美的状态

NG料排出来了，那么人工要去处理，条码绑定失败之后  MES出站接口是否需要调用，如果要，那出站是否能过，如果出站能过，那么下一道的转接片进站是不是就进不去，

我离线上传的功能，代码逻辑要改动

代码上建议，MES用事件处理，个人建议，因为你昨天说了，不能在接口耗费太多的时间







注意前端的数据，每一次切换到产品数据，其实是来自数据库（默认进行了一次查询）



**条码绑定从预焊到终焊**

条码绑定失败之后，还是让PLC当成MES出站NG排出，这个没有问题，和转接片一样，job中绑定失败之后，给PLC回复35，不再调用MES出站接口

在人工处理这个电芯之后，提供数据补录的按钮功能

对于终焊机，这个数据补录的按钮中的逻辑要**特殊处理**，在调用MES出站接口之前，要调用 条码绑定的接口

这个条码绑定 如果MES返回成功，那么记录到数据库中，此时调用mes出站接口，OK则完成操作，并且数据库中条码绑定记录删除

如果条码绑定返回失败，那么MES出站接口不再调用

如果第一次 条码绑定返回成功，那么 第二次进来的时候，从数据库中的数据判断（如果DB中有，那么条码绑定不再调用，如果没有，那么还是要调用 条码绑定接口），



特别注意，在出站JOB，对于超声波终焊而言，要**特殊处理**，与补录一样，条码绑定失败之后，记录在数据库表中，出站成功之后将这条记录删除













1，上料 下料的操作 在操作数据库的同时，也在将数据库的数据同步到内存中，

​			前端获取物料列表，是通过控制器将内存的数据推给前端

2，在前端字典表的所有操作，都是在直接操作数据库（同步到数据库）

3，同步配置时，是在同步  数据库和本地内存的数据的数据









![](../../项目文档/BS/龙净整线/问题点收集/新增需求/上料下料客户需求.jpg)



1，第一点需求，我注释掉了那一行代码，如图

![](../../项目文档/BS/龙净整线/问题点收集/解决方案/第一点.png)

![](../../项目文档/BS/龙净整线/问题点收集/解决方案/第一点2.png)







2，第二点需求，我做了一个事件处理的操作，如图

![](../../项目文档/BS/龙净整线/问题点收集/解决方案/第二点.png)

在出站job 调用MES方法的地方，当mes出站接口以及条码绑定接口调用失败  而给PLC回复35 之后立刻发布事件

代码如图

![](../../项目文档/BS/龙净整线/问题点收集/解决方案/第二2.png)



3，物料上下料需求的 **分析**

 目前**前端**物料列表的数据 直接来自**内存缓存**，

并且每一次的 **上料，卸料**操作      ，都会将  **内存缓存**与**数据库的数据**（字典表） 保持**同步**

既然  物料的消耗状态 改为以MES的数据为准，那么是不是  可以**不用**再将数据同步 到数据库（因为这个MES更新物料的接口   可能会频繁的调用，见下文）



图中最后一个提到的需求，**定时刷新**

对于后端而言，可以用调度中心 控制 job的启动与暂停（在job中定时推送），也可以配置化这个job的定时时间

可是对于前端而言，我不确定能不能 按照客户的想法 定时刷新这个 前端的物料列表，就类似于后台PLC调式界面的实时更新列表

（如果太过麻烦，我可以和再客户沟通一下，这个需求点是客户新增直接发出来的，没有与我 事先说明，

个人理解，如果一定要做的话，那么这个定时时间的设定，根据12的PPM，那么一个料5秒，物料消耗应该也是5秒，所以这个定时时间起码大于等于5秒，5秒调用一次物料更新接口）

我测试了一下 调度中心的使用    如图代码

![](../../项目文档/BS/龙净整线/问题点收集/解决方案/job点.png)

测试结果如图

![](../../项目文档/BS/龙净整线/问题点收集/解决方案/第三点2.png)





最后关于顶盖焊数据丢失的情况，

个人分析，可能原因：

1，倍福PLC硬件问题

2，ADS路由问题

3，出站job中，如果得到了PLC的触发信号，会有会有  数据信道读取  **出站数据区** 和 **出站字符区**  **失败**的情况







2024-03-16

1，确认 心跳异常时（比如说在一定时间内没有收到上位机写入的1 ）是否能  停机报警，这个一定时间，目前PLC是设置的多长时间

2，确认 MES状态是否成功同步到PLC，MES离线时，上位机是否会发送false信号给PLC，当PLC检测到上位机发送false时  是否能停机报警

3，确认 在MES出站NG时 ，上位机是否会发送信号1 ，PLC是否能检测这个信号，检测到之后是否 能停机报警

4，确认 MES进站NG之后，PLC收到上位机的35之后，是否还会再 出站触发（不能出站触发）





4，确认  前端的 MES模式切换是否可以  ,加入 权限管理















